<!DOCTYPE html>
<html lang="es" data-theme="emerald">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gaceta Nuevo Comienzo — Revista Digital</title>

  <!-- Tailwind + DaisyUI (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PDF.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>

  <style>
    /* ===== LOADER ===== */
    #topLoader{position:fixed;inset:0 auto auto 0;height:4px;width:0%;background:linear-gradient(90deg,#10b981,#22c55e,#06b6d4);box-shadow:0 0 14px rgba(16,185,129,.6);z-index:9999;transition:width .3s ease}
    #loginLoader{position:fixed;inset:0;background:radial-gradient(1200px 800px at 50% 40%,rgba(12,18,28,.95),rgba(5,10,20,.98) 60%,rgba(0,0,0,1));display:grid;place-items:center;z-index:9998}
    .login-animate-pulse{animation:pulseGlow 2.2s ease-in-out infinite}
    @keyframes pulseGlow{0%,100%{filter:none;transform:scale(1)}50%{filter:drop-shadow(0 0 18px rgba(16,185,129,.45));transform:scale(1.02)}}
    .login-animate-spin-slow{animation:orb 3s linear infinite}
    @keyframes orb{to{transform:rotate(360deg)}}
    .loader{width:56px;height:56px;border-radius:50%;border:3px solid #1f2937;border-top-color:#10b981;margin:0 auto;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .goldman-text{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;letter-spacing:.3px}

    /* ===== Flipbook (SIEMPRE 1 página) ===== */
    .flipbook{perspective:1600px;transform-style:preserve-3d;user-select:none;-webkit-tap-highlight-color:transparent}
    .sheet{position:relative;width:var(--sheet-w,820px);height:var(--sheet-h,1160px);transform-style:preserve-3d}
    .page{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden;backface-visibility:hidden;box-shadow:0 10px 30px rgba(0,0,0,.22);background:#fff;transform-origin:right center}
    .page img{width:100%;height:100%;object-fit:contain;display:block;background:#fff}
    .sheet.turning .page{animation:turnSingle .5s ease forwards}
    @keyframes turnSingle{0%{transform:rotateY(0);z-index:2}100%{transform:rotateY(180deg);z-index:1}}
    .zoomable{transition:transform .18s ease;transform-origin:center}
    .thumb{aspect-ratio:3/4;object-fit:cover}

    /* ===== UI ===== */
    .brand-gradient{background:linear-gradient(90deg,#0b2441 0%,#1e3e6b 50%,#0e8f8b 100%)}
    .soft-card{border:1px solid rgba(15,23,42,.08)}
    #stage{min-height:58vh}

    /* ===== Mobile ===== */
    @media (max-width: 1023px){
      #sidebar{display:none}
      #thumbToggle{display:inline-flex}
      #stage{min-height:70vh}
      .navbar .btn{min-height:2rem;height:2rem}
      .navbar .btn.btn-sm{min-height:1.75rem;height:1.75rem}
    }
  </style>
</head>
<body class="min-h-screen bg-base-200">
  <!-- LOADER -->
  <div id="topLoader" hidden></div>
  <div id="loginLoader" aria-hidden="true">
    <div class="text-center">
      <div class="relative w-60 h-60 mx-auto mb-6">
        <img src="img/logobrand5.png" alt="DGSP" class="w-full h-full object-contain login-animate-pulse">
        <div class="absolute -top-2 -left-2 w-12 h-12 rounded-full bg-blue-500/20 login-animate-spin-slow"></div>
        <div class="absolute -bottom-2 -right-2 w-10 h-10 rounded-full bg-purple-500/20 login-animate-spin-slow" style="animation-direction:reverse"></div>
        <div class="absolute -top-2 -right-2 w-8 h-8 rounded-full bg-pink-500/20 login-animate-spin-slow" style="animation-duration:4s"></div>
        <div class="absolute -bottom-2 -left-2 w-6 h-6 rounded-full bg-yellow-500/20 login-animate-spin-slow" style="animation-duration:5s"></div>
      </div>
      <p class="text-white text-xl font-medium mb-3 goldman-text">Dirección General del Sistema Penitenciario</p>
      <div class="loader"></div>
    </div>
  </div>

  <!-- NAVBAR -->
  <header class="navbar bg-base-100 shadow-sm sticky top-0 z-40">
    <div class="flex-1">
      <a class="btn btn-ghost normal-case text-xl font-bold">Gaceta Nuevo Comienzo — Revista Digital</a>
    </div>
    <div class="flex-none gap-2 pr-2">
      <button id="thumbToggle" class="btn btn-sm hidden">Miniaturas</button>
      <button id="btnPrev" class="btn btn-sm">←</button>
      <button id="btnNext" class="btn btn-sm">→</button>
      <div class="divider divider-horizontal hidden md:block"></div>
      <button id="btnZoomOut" class="btn btn-sm hidden md:inline-flex">−</button>
      <button id="btnZoomIn"  class="btn btn-sm hidden md:inline-flex">+</button>
      <button id="btnResetZoom" class="btn btn-sm hidden md:inline-flex">100%</button>
      <div class="divider divider-horizontal hidden md:block"></div>
      <button id="btnFullscreen" class="btn btn-sm hidden md:inline-flex">⤢</button>
    </div>
  </header>

  <!-- HERO -->
  <section class="brand-gradient text-white">
    <div class="max-w-7xl mx-auto px-4 py-3 md:py-5 flex items-center justify-between">
      <div>
        <h1 class="text-base md:text-2xl font-semibold">Septiembre 2025 · Edición Especial</h1>
        <p class="opacity-90 text-xs md:text-base">Historias reales de reinserción, proyectos que transforman y datos que inspiran.</p>
      </div>
      <img src="img/logobrand5.png" alt="DGSP" class="hidden md:block h-10 opacity-90">
    </div>
  </section>

  <!-- LAYOUT -->
  <main class="max-w-7xl mx-auto p-3 lg:p-6">
    <div class="grid grid-cols-1 lg:grid-cols-[260px,1fr] gap-4">
      <!-- Sidebar -->
      <aside id="sidebar" class="card bg-base-100 soft-card shadow-sm h-[60vh] lg:h-[86vh]">
        <div class="card-body p-3">
          <h2 class="card-title text-sm mb-3">Revista</h2>
          <div class="join w-full mb-2">
            <a id="btnDownloadPdf" class="btn btn-primary btn-sm join-item" download>Descargar PDF</a>
            <a id="btnOpenPdf" class="btn btn-outline btn-sm join-item" target="_blank" rel="noopener">Abrir PDF</a>
          </div>
          <div class="text-xs opacity-70 mb-2">
            <span id="metaPages">Páginas: —</span> ·
            <span id="metaWeight">Peso aprox.: —</span>
          </div>
          <div class="divider my-2"></div>
          <h3 class="text-xs font-medium mb-2">Miniaturas</h3>
          <div id="thumbs" class="overflow-auto h-full grid grid-cols-3 lg:grid-cols-1 gap-2 pr-1"></div>
        </div>
      </aside>

      <!-- Flipbook -->
      <section class="card bg-base-100 soft-card shadow-sm">
        <div class="card-body p-2 md:p-4">
          <div id="stage" class="w-full flex justify-center">
            <div id="book" class="flipbook zoomable"></div>
          </div>
          <div class="mt-3 flex flex-col md:flex-row md:items-center md:justify-between text-xs opacity-70 gap-2">
            <p id="caption" class="text-center md:text-left">Toca/arrastra o usa ← → para pasar página.</p>
            <p id="status" class="text-center md:text-right">Listo</p>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="footer bg-base-100 text-base-content border-t mt-6">
    <div class="max-w-7xl mx-auto w-full px-4 py-6 grid grid-cols-1 md:grid-cols-3 gap-3">
      <div>
        <h4 class="font-semibold">Dirección General del Sistema Penitenciario</h4>
        <p class="text-sm opacity-75">Dirección de Tecnologías y Control Penitenciario. Secretaría de Seguridad y Paz.</p>
      </div>
      <div class="text-sm opacity-75">
        <a href="#" class="link link-hover">Aviso de privacidad</a><br>
        <a href="#" class="link link-hover">Términos de uso</a>
      </div>
      <div class="text-sm opacity-75">
        <a href="#" class="link link-hover">Sitio oficial</a><br>
        <a href="#" class="link link-hover">Contacto</a>
      </div>
    </div>
  </footer>

  <script>
    /* ====== CONFIG ====== */
    const PDF_URL = "./docs/revista.pdf";   // <-- ruta relativa (GitHub Pages ok)
    const MIN_LOADER_MS = 2000;
    const AUTO_SPLIT_SPREADS = true;        // <--- clave: partir páginas dobles automáticamente

    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";

    /* ====== REFS / STATE ====== */
    const $book   = document.getElementById('book');
    const $stage  = document.getElementById('stage');
    const $thumbs = document.getElementById('thumbs');
    const $status = document.getElementById('status');
    const $metaPages = document.getElementById('metaPages');
    const $metaWeight = document.getElementById('metaWeight');
    const $btnOpenPdf = document.getElementById('btnOpenPdf');
    const $btnDownloadPdf = document.getElementById('btnDownloadPdf');
    const $thumbToggle = document.getElementById('thumbToggle');
    const $sidebar = document.getElementById('sidebar');

    let state = { page: 0, zoom: 1, pagesSrc: [], pageAspect: 1.414 };
    let loaderStart = 0;

    /* ====== LOADER ====== */
    const $topLoader   = document.getElementById('topLoader');
    const $loginLoader = document.getElementById('loginLoader');

    function showLoaders(){
      loaderStart=performance.now(); $topLoader.hidden=false; $topLoader.style.width='0%';
      clearInterval($topLoader._timer); let w=0;
      $topLoader._timer=setInterval(()=>{ w=Math.min(97,w+Math.random()*7); $topLoader.style.width=w+'%'; },180);
      $loginLoader.style.display='grid';
    }
    function hideLoadersIfReady(){
      const loaded=document.documentElement.getAttribute('data-window-loaded')==='yes';
      const rendered=document.documentElement.getAttribute('data-first-render')==='done';
      if(loaded&&rendered){
        const wait=Math.max(0, MIN_LOADER_MS-(performance.now()-loaderStart));
        setTimeout(()=>{
          $topLoader.style.width='100%';
          setTimeout(()=>{ $topLoader.hidden=true; clearInterval($topLoader._timer); },250);
          $loginLoader.style.opacity='1'; $loginLoader.style.transition='opacity .35s ease';
          requestAnimationFrame(()=>{ $loginLoader.style.opacity='0'; setTimeout(()=> $loginLoader.style.display='none',350); });
        },wait);
      }
    }
    window.addEventListener('beforeunload', ()=>{ $topLoader.hidden=false; $topLoader.style.width='10%'; $loginLoader.style.display='grid'; });
    window.addEventListener('load', ()=>{ document.documentElement.setAttribute('data-window-loaded','yes'); hideLoadersIfReady(); });

    /* ====== Sidebar en móvil ====== */
    document.getElementById('thumbToggle')?.addEventListener('click', ()=>{
      const isHidden=getComputedStyle($sidebar).display==='none';
      $sidebar.style.display=isHidden?'block':'none';
      if(isHidden) window.scrollTo({top:$sidebar.offsetTop-64,behavior:'smooth'});
    });

    /* ====== Auto-fit 1 página ====== */
    function fitBook(){
      const sw = Math.max(320, $stage.clientWidth);
      const vhTop = $stage.getBoundingClientRect().top;
      const sh = Math.max(360, window.innerHeight - vhTop - 110);
      const pageW = Math.min(sw, sh / state.pageAspect);
      const sheetW = pageW, sheetH = pageW * state.pageAspect;
      document.documentElement.style.setProperty('--sheet-w', sheetW + 'px');
      document.documentElement.style.setProperty('--sheet-h', sheetH + 'px');
      $book.style.transform = 'scale(1)'; // vista 1:1, ya ajustada
    }
    window.addEventListener('resize', fitBook);

    /* ====== Crear hoja ====== */
    function createSheet(index){
      const sheet=document.createElement('div'); sheet.className='sheet';
      const page=document.createElement('div'); page.className='page';
      const img=document.createElement('img');
      if(index>=0 && state.pagesSrc[index]){ img.loading='lazy'; img.src=state.pagesSrc[index]; img.alt=`Página ${index+1}`; }
      page.appendChild(img); sheet.appendChild(page);
      return sheet;
    }

    function render(){
      $book.innerHTML=''; $book.classList.add('relative');
      if(!state.pagesSrc.length) return;
      fitBook();
      $book.appendChild(createSheet(state.page));
      updateThumbsSelection();
      document.documentElement.setAttribute('data-first-render','done'); hideLoadersIfReady();
      $status.textContent=`Página ${state.page+1} de ${state.pagesSrc.length}`;
    }

    function nextPage(){ if(state.page < state.pagesSrc.length-1){ state.page+=1; animateTurn(); render(); } }
    function prevPage(){ if(state.page > 0){ state.page-=1; animateTurn(); render(); } }
    function animateTurn(){
      const sheet=$book.querySelector('.sheet'); if(!sheet) return;
      sheet.classList.remove('turning'); void sheet.offsetWidth; sheet.classList.add('turning');
      setTimeout(()=>sheet.classList.remove('turning'),520);
    }

    // Controles
    document.getElementById('btnNext').onclick=nextPage;
    document.getElementById('btnPrev').onclick=prevPage;
    document.getElementById('btnZoomIn').onclick = ()=>{};
    document.getElementById('btnZoomOut').onclick= ()=>{};
    document.getElementById('btnResetZoom').onclick=()=>{};
    document.getElementById('btnFullscreen').onclick=()=>{ const el=document.documentElement; !document.fullscreenElement?el.requestFullscreen():document.exitFullscreen(); };

    // Click mitad der/izq y teclado
    $book.addEventListener('click',ev=>{ const r=$book.getBoundingClientRect(); (ev.clientX-r.left>r.width/2)?nextPage():prevPage(); });
    window.addEventListener('keydown',e=>{ if(['ArrowRight','PageDown',' '].includes(e.key)) nextPage(); if(['ArrowLeft','PageUp','Backspace'].includes(e.key)) prevPage(); });

    // Swipe
    let sx=0,sy=0;
    $book.addEventListener('touchstart',e=>{ sx=e.touches[0].clientX; sy=e.touches[0].clientY; },{passive:true});
    $book.addEventListener('touchend',e=>{ const dx=e.changedTouches[0].clientX-sx; const dy=Math.abs(e.changedTouches[0].clientY-sy); if(Math.abs(dx)>30 && dy<50){ dx<0?nextPage():prevPage(); } },{passive:true});

    /* ====== Miniaturas ====== */
    function buildThumbs(){
      $thumbs.innerHTML='';
      state.pagesSrc.forEach((src,i)=>{
        const btn=document.createElement('button');
        btn.className='btn btn-ghost p-0 overflow-hidden border border-base-300 hover:border-primary rounded-lg';
        const img=document.createElement('img');
        img.src=src; img.alt=`Miniatura ${i+1}`; img.className='thumb w-[110px] lg:w-full';
        btn.appendChild(img); btn.onclick=()=>{ state.page=i; render(); };
        $thumbs.appendChild(btn);
      });
    }
    function updateThumbsSelection(){
      [...$thumbs.children].forEach((b,i)=>{ const active=i===state.page; b.classList.toggle('ring',active); b.classList.toggle('ring-primary',active); });
    }

    /* ====== PDF -> imágenes (con PARTIDO DE SPREADS) ====== */
    function splitCanvasInTwo(canvas){
      const half = Math.floor(canvas.width/2);
      const makeHalf = (sx) => {
        const c = document.createElement('canvas');
        c.width = half; c.height = canvas.height;
        const ctx = c.getContext('2d');
        ctx.drawImage(canvas, sx, 0, half, canvas.height, 0, 0, half, canvas.height);
        return c.toDataURL('image/jpeg', 0.92);
      };
      // Orden lectura: izquierda, derecha
      return [ makeHalf(0), makeHalf(half) ];
    }

    async function pdfToImages(pdfUrl){
      try{
        $status.textContent='Cargando PDF…';
        const loadingTask=pdfjsLib.getDocument(pdfUrl);
        const pdf=await loadingTask.promise;
        const totalPdfPages=pdf.numPages;

        $btnOpenPdf.href=pdfUrl; $btnDownloadPdf.href=pdfUrl;

        const pages=[];
        for(let p=1;p<=totalPdfPages;p++){
          $status.textContent=`Renderizando página ${p}/${totalPdfPages}…`;
          const page=await pdf.getPage(p);
          const vp=page.getViewport({scale:1});
          if(p===1) state.pageAspect = (vp.height/vp.width >= 1) ? vp.height/vp.width : 1.414; // default retrato

          // Render nítido según ancho del contenedor
          const stageW = Math.max(360, $stage.clientWidth || 800);
          const targetW = Math.round(Math.min(2200, Math.max(900, stageW * (window.devicePixelRatio||1.25) * 1.2)));
          const scale=targetW/vp.width;
          const rvp=page.getViewport({scale});
          const canvas=document.createElement('canvas');
          const ctx=canvas.getContext('2d');
          canvas.width=Math.floor(rvp.width);
          canvas.height=Math.floor(rvp.height);
          await page.render({canvasContext:ctx,viewport:rvp}).promise;

          const isSpread = AUTO_SPLIT_SPREADS && (vp.width > vp.height * 1.1); // apaisada => dos páginas
          if(isSpread){
            const [left,right] = splitCanvasInTwo(canvas);
            // Para spreads, la relación de una sola hoja es (alto / (ancho/2))
            state.pageAspect = canvas.height / (canvas.width/2);
            pages.push(left, right);
          }else{
            pages.push(canvas.toDataURL('image/jpeg',0.92));
          }
        }

        // Meta (después de partir)
        const bytes=pages.reduce((a,d)=>a+Math.max(0,(d.length*3/4)-8142),0);
        const mb=(bytes/(1024*1024)).toFixed(1);
        document.getElementById('metaPages').textContent = `Páginas: ${pages.length}`;
        document.getElementById('metaWeight').textContent = `Peso aprox.: ${mb} MB`;

        return pages;
      }catch(err){
        console.error('Error PDF:',err);
        $status.textContent='No se pudo cargar el PDF (revisa ruta/CORS).';
        return [];
      }
    }

    /* ====== INIT ====== */
    async function init(){
      showLoaders();
      const pages=await pdfToImages(PDF_URL);
      state.pagesSrc=pages;
      buildThumbs();
      state.page=0;
      render();
    }
    init();
  </script>
</body>
</html>
